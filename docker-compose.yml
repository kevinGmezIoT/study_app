services:
  api:
    #image: fabriziossr/study_app_api:latest
    build:
      context: .
      dockerfile: Dockerfile.dockerfile
    container_name: study_app_api
    ports: ["8000:8000"]
    environment:
      # API reads .env via python-dotenv if present, but we set runtime envs here:
      DB_PATH: /data/exams.db
      OLLAMA_URL: http://host.docker.internal:11434
      OLLAMA_MODEL: llama3.2:3b
    volumes:
      # persist/load your SQLite outside the image
      - F:/Windows7-USER/Disco D/Documentos del disco C/Cursos/IA Especializaci√≥n GenAI/Taller 7/taller_last/data/temporal/exams.db:/data/exams.db
      #- ./data/temporal:/data/temporal
    extra_hosts:
      # helps Linux users resolve host.docker.internal
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 5
  grafana:
    image: grafana/grafana:10.4.2
    ports: ["3000:3000"]
    depends_on: [prometheus]
  prometheus:
    image: prom/prometheus:v2.53.0
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports: ["9090:9090"]
    depends_on: [api]
  ui:
    build:
      context: .
      dockerfile: Dockerfile.dockerfile
    container_name: study_app_ui
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "8501:8501"
    environment:
      # Streamlit needs to know how to call the API service
      API_URL: http://api:8000
    command: ["streamlit", "run", "streamlit.py", "--server.port=8501", "--server.address=0.0.0.0"]
